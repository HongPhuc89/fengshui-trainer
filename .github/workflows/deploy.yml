name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit
        run: |
          echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_DIR: ${{ secrets.VPS_DIR }}
          COMMIT_HASH: ${{ steps.commit.outputs.hash }}
          COMMIT_BRANCH: ${{ steps.commit.outputs.branch }}
        run: |
          echo "ðŸš€ Deploying to VPS..."
          echo "Commit: $COMMIT_HASH"
          echo "Branch: $COMMIT_BRANCH"

          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            # Navigate to project directory
            cd ${{ secrets.VPS_DIR }}
            
            echo "ðŸ“¦ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ðŸ“ Installing dependencies..."
            npm install
            
            echo "ðŸ—ï¸ Building applications..."
            npm run build
            
            echo "ðŸ”„ Restarting services..."
            pm2 restart all || pm2 start ecosystem.config.js
            
            echo "âœ… Deployment completed!"
            echo "Deployed commit: ${{ steps.commit.outputs.hash }}"
          ENDSSH

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ðŸ” Verifying deployment..."
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            pm2 list
            pm2 logs --lines 20 --nostream
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
